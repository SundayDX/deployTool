<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目部署管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .system-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            flex: 1;
            min-width: 200px;
        }

        .system-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .btn-system {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-system:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn-settings {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .btn-settings:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(250, 112, 154, 0.4);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .project-card h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .project-card p {
            color: #666;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .project-path {
            color: #999;
            font-family: monospace;
            background: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 15px;
            word-break: break-all;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn-deploy {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-deploy:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-deploy:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: scale(1);
        }

        .btn-status {
            background: #f0f0f0;
            color: #333;
        }

        .btn-status:hover {
            background: #e0e0e0;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn-pull-build {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            flex: 1;
            min-width: 120px;
        }

        .btn-pull-build:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-pull-build:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: scale(1);
        }

        .btn-restart {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            flex: 1;
            min-width: 120px;
        }

        .btn-restart:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
        }

        .btn-restart:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: scale(1);
        }

        .btn-clean {
            background: linear-gradient(135deg, #ffa500 0%, #ff6347 100%);
            color: white;
            flex: 1;
            min-width: 100px;
        }

        .btn-clean:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 165, 0, 0.4);
        }

        .btn-clean:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: scale(1);
        }

        .btn-advanced {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-advanced:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-execute {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            min-width: 80px;
        }

        .btn-execute:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn-execute:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: scale(1);
        }

        .advanced-panel {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            display: none;
            border-left: 4px solid #667eea;
        }

        .advanced-panel.show {
            display: block;
        }

        .command-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .command-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            transition: border-color 0.3s;
        }

        .command-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .command-hints {
            color: #666;
            font-size: 0.85em;
        }

        .status-info {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            font-size: 0.85em;
            display: none;
        }

        .status-info.show {
            display: block;
        }

        .status-info pre {
            white-space: pre-wrap;
            word-break: break-all;
            color: #555;
            font-family: monospace;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #000;
        }

        .log-entry {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 6px;
            background: #f5f5f5;
        }

        .log-entry.success {
            border-left: 4px solid #4caf50;
        }

        .log-entry.error {
            border-left: 4px solid #f44336;
        }

        .log-entry h3 {
            margin-bottom: 8px;
            color: #333;
        }

        .log-entry pre {
            background: white;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.85em;
            color: #555;
        }

        .log-output {
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>项目部署管理系统</h1>

        <div class="top-bar">
            <div class="system-card">
                <button class="btn btn-system" onclick="showSystemInfo()">查看系统信息</button>
            </div>
            <div class="system-card">
                <button class="btn btn-settings" onclick="showSettings()">系统设置</button>
            </div>
            <div class="system-card">
                <button class="btn btn-deploy" onclick="showProjectManagement()">项目管理</button>
            </div>
        </div>

        <div id="alert-container"></div>

        <div class="projects-grid" id="projects-container">
            <p style="color: white; text-align: center;">加载中...</p>
        </div>
    </div>

    <div id="logModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('logModal')">&times;</span>
            <h2>部署日志</h2>
            <div id="logContent"></div>
        </div>
    </div>

    <div id="systemModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('systemModal')">&times;</span>
            <h2>系统信息</h2>
            <div id="systemContent">加载中...</div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('settingsModal')">&times;</span>
            <h2>系统设置</h2>
            <div id="settingsContent">
                <div style="margin-bottom: 20px;">
                    <h3>钉钉通知设置</h3>
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="checkbox" id="dingtalk-enabled" onchange="toggleDingtalkSettings()">
                            启用钉钉通知
                        </label>
                        <div id="dingtalk-settings" style="display: none;">
                            <label style="display: block; margin-bottom: 10px;">
                                <span style="display: block; margin-bottom: 5px; font-weight: bold;">Webhook URL:</span>
                                <input type="text" id="dingtalk-webhook" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="https://oapi.dingtalk.com/robot/send?access_token=...">
                            </label>
                            <label style="display: block; margin-bottom: 10px;">
                                <span style="display: block; margin-bottom: 5px; font-weight: bold;">Secret (可选):</span>
                                <input type="text" id="dingtalk-secret" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="留空或输入加签密钥">
                            </label>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-deploy" onclick="saveSettings()">保存设置</button>
                    <button class="btn btn-system" onclick="testDingtalk()" style="margin-left: 10px;">测试钉钉通知</button>
                </div>
            </div>
        </div>
    </div>

    <div id="projectManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('projectManagementModal')">&times;</span>
            <h2>项目管理</h2>
            <div id="projectManagementContent">
                <button class="btn btn-deploy" onclick="showAddProjectForm()" style="margin-bottom: 20px;">添加新项目</button>

                <div id="addProjectForm" style="display: none; background: #f5f5f5; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                    <h3>添加/编辑项目</h3>
                    <input type="hidden" id="edit-project-id" value="">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">项目名称:</label>
                        <input type="text" id="project-name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="我的项目">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">项目描述:</label>
                        <input type="text" id="project-description" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="项目描述（可选）">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">项目路径:</label>
                        <input type="text" id="project-path" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="/path/to/your/project">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block;">
                            <input type="checkbox" id="project-auto-restart" checked>
                            自动重启服务
                        </label>
                    </div>
                    <div style="margin-bottom: 15px; border-top: 2px solid #ddd; padding-top: 15px;">
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="checkbox" id="ssh-enabled" onchange="toggleSSHFields()">
                            <strong>启用SSH远程执行</strong>
                        </label>
                        <div id="ssh-fields" style="display: none; padding-left: 20px; background: #fafafa; padding: 15px; border-radius: 4px;">
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">SSH主机:</label>
                                <input type="text" id="ssh-host" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="192.168.1.100 或 example.com">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">SSH端口:</label>
                                <input type="number" id="ssh-port" value="22" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">SSH用户名:</label>
                                <input type="text" id="ssh-user" value="root" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">认证方式:</label>
                                <select id="ssh-auth-type" onchange="toggleSSHAuthFields()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="key">SSH密钥 (推荐)</option>
                                    <option value="password">密码认证</option>
                                </select>
                            </div>
                            <div id="ssh-key-field" style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">SSH私钥路径:</label>
                                <input type="text" id="ssh-key-file" placeholder="/root/.ssh/id_rsa" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <small style="color: #666;">留空则使用默认密钥 (~/.ssh/id_rsa 或 ~/.ssh/id_ed25519)</small>
                            </div>
                            <div id="ssh-password-field" style="margin-bottom: 10px; display: none;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">SSH密码:</label>
                                <input type="password" id="ssh-password" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <small style="color: #ff9800;">⚠️ 不推荐使用密码认证，建议使用SSH密钥</small>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-deploy" onclick="saveProject()">保存项目</button>
                        <button class="btn btn-status" onclick="cancelProjectForm()" style="margin-left: 10px;">取消</button>
                    </div>
                </div>

                <div id="projectsList"></div>
            </div>
        </div>
    </div>

    <script>
        let projects = [];

        // 加载项目列表
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                projects = await response.json();
                renderProjects();
            } catch (error) {
                showAlert('加载项目失败: ' + error.message, 'error');
            }
        }

        // 渲染项目列表
        function renderProjects() {
            const container = document.getElementById('projects-container');

            if (projects.length === 0) {
                container.innerHTML = '<p style="color: white; text-align: center;">暂无项目，请在 projects.json 中配置</p>';
                return;
            }

            container.innerHTML = projects.map((project, index) => `
                <div class="project-card">
                    <h2>${project.name}</h2>
                    <p>${project.description || '暂无描述'}</p>
                    <div class="project-path">${project.path}</div>
                    <div class="button-group">
                        <button class="btn btn-pull-build" onclick="pullBuildProject(${index})">
                            <span id="pull-build-text-${index}">Pull & Build</span>
                        </button>
                        <button class="btn btn-restart" onclick="restartProject(${index})">
                            <span id="restart-text-${index}">Down & Up</span>
                        </button>
                        <button class="btn btn-clean" onclick="cleanProject(${index})">
                            <span id="clean-text-${index}">Clean</span>
                        </button>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-status" onclick="toggleStatus(${index})">查看状态</button>
                        <button class="btn btn-deploy" onclick="deployProject(${index})">
                            <span id="deploy-text-${index}">一键部署</span>
                        </button>
                        <button class="btn btn-advanced" onclick="toggleAdvanced(${index})">高级</button>
                    </div>
                    <div class="advanced-panel" id="advanced-${index}">
                        <div class="command-input-group">
                            <input type="text" id="custom-command-${index}" class="command-input" placeholder="输入自定义命令，如: docker logs -f container_name" />
                            <button class="btn btn-execute" onclick="executeCustomCommand(${index})">
                                <span id="execute-text-${index}">执行</span>
                            </button>
                        </div>
                        <div class="command-hints">
                            <small>提示: 命令将在项目目录下执行。危险命令会被自动拦截。</small>
                        </div>
                    </div>
                    <div class="status-info" id="status-${index}">
                        <div id="status-content-${index}">加载中...</div>
                    </div>
                </div>
            `).join('');
        }

        // 部署项目
        async function deployProject(projectId) {
            const btn = document.querySelector(`#deploy-text-${projectId}`).parentElement;
            const originalText = document.querySelector(`#deploy-text-${projectId}`).textContent;

            btn.disabled = true;
            document.querySelector(`#deploy-text-${projectId}`).innerHTML = '<span class="loading"></span> 部署中...';

            // 打开日志模态窗口并准备显示实时日志
            const modal = document.getElementById('logModal');
            const content = document.getElementById('logContent');
            content.innerHTML = '<div class="log-entry"><h3>准备部署...</h3></div>';
            modal.style.display = 'block';

            // 使用 EventSource 接收实时流式数据
            const eventSource = new EventSource(`/api/deploy-stream/${projectId}`);
            let currentStep = null;
            let currentStepDiv = null;
            let currentOutputPre = null;

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.type === 'start') {
                    content.innerHTML = `<div class="log-entry"><h3>开始部署: ${data.project}</h3></div>`;
                } else if (data.type === 'step') {
                    if (data.status === 'running') {
                        // 创建新的步骤区域
                        currentStep = data.step;
                        currentStepDiv = document.createElement('div');
                        currentStepDiv.className = 'log-entry';
                        currentStepDiv.innerHTML = `
                            <h3><span class="loading"></span> ${data.step}...</h3>
                            <pre class="log-output"></pre>
                        `;
                        content.appendChild(currentStepDiv);
                        currentOutputPre = currentStepDiv.querySelector('.log-output');

                        // 滚动到底部
                        content.scrollTop = content.scrollHeight;
                    } else if (data.status === 'success') {
                        // 标记步骤成功
                        if (currentStepDiv && data.step === currentStep) {
                            currentStepDiv.className = 'log-entry success';
                            currentStepDiv.querySelector('h3').innerHTML = `✓ ${data.step}`;
                        }
                    } else if (data.status === 'error') {
                        // 标记步骤失败
                        if (currentStepDiv && data.step === currentStep) {
                            currentStepDiv.className = 'log-entry error';
                            currentStepDiv.querySelector('h3').innerHTML = `✗ ${data.step}`;
                        }
                    }
                } else if (data.type === 'output') {
                    // 添加命令输出
                    if (currentOutputPre && data.step === currentStep) {
                        currentOutputPre.textContent += data.line + '\n';
                        // 滚动到底部
                        content.scrollTop = content.scrollHeight;
                    }
                } else if (data.type === 'complete') {
                    // 部署完成
                    eventSource.close();

                    if (data.success) {
                        showAlert('部署成功！', 'success');
                        const completeDiv = document.createElement('div');
                        completeDiv.className = 'log-entry success';
                        completeDiv.innerHTML = `<h3>✓ 部署完成</h3><p>${data.message}</p>`;
                        content.appendChild(completeDiv);
                    } else {
                        showAlert('部署失败: ' + data.message, 'error');
                        const completeDiv = document.createElement('div');
                        completeDiv.className = 'log-entry error';
                        completeDiv.innerHTML = `<h3>✗ 部署失败</h3><p>${data.message}</p>`;
                        content.appendChild(completeDiv);
                    }

                    // 恢复按钮状态
                    btn.disabled = false;
                    document.querySelector(`#deploy-text-${projectId}`).textContent = originalText;

                    // 滚动到底部
                    content.scrollTop = content.scrollHeight;
                }
            };

            eventSource.onerror = function(error) {
                console.error('EventSource error:', error);
                eventSource.close();
                showAlert('部署过程中发生错误', 'error');

                const errorDiv = document.createElement('div');
                errorDiv.className = 'log-entry error';
                errorDiv.innerHTML = `<h3>✗ 连接错误</h3><p>无法连接到服务器</p>`;
                content.appendChild(errorDiv);

                // 恢复按钮状态
                btn.disabled = false;
                document.querySelector(`#deploy-text-${projectId}`).textContent = originalText;
            };
        }

        // 通用流式执行函数
        function executeStreamAction(projectId, endpoint, buttonId, actionName) {
            const btn = document.querySelector(`#${buttonId}-${projectId}`).parentElement;
            const originalText = document.querySelector(`#${buttonId}-${projectId}`).textContent;

            btn.disabled = true;
            document.querySelector(`#${buttonId}-${projectId}`).innerHTML = `<span class="loading"></span> 执行中...`;

            // 打开日志模态窗口并准备显示实时日志
            const modal = document.getElementById('logModal');
            const content = document.getElementById('logContent');
            content.innerHTML = `<div class="log-entry"><h3>准备 ${actionName}...</h3></div>`;
            modal.style.display = 'block';

            // 使用 EventSource 接收实时流式数据
            const eventSource = new EventSource(`/api/${endpoint}/${projectId}`);
            let currentStep = null;
            let currentStepDiv = null;
            let currentOutputPre = null;

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.type === 'start') {
                    content.innerHTML = `<div class="log-entry"><h3>开始 ${actionName}: ${data.project}</h3></div>`;
                } else if (data.type === 'step') {
                    if (data.status === 'running') {
                        currentStep = data.step;
                        currentStepDiv = document.createElement('div');
                        currentStepDiv.className = 'log-entry';
                        currentStepDiv.innerHTML = `
                            <h3><span class="loading"></span> ${data.step}...</h3>
                            <pre class="log-output"></pre>
                        `;
                        content.appendChild(currentStepDiv);
                        currentOutputPre = currentStepDiv.querySelector('.log-output');
                        content.scrollTop = content.scrollHeight;
                    } else if (data.status === 'success') {
                        if (currentStepDiv && data.step === currentStep) {
                            currentStepDiv.className = 'log-entry success';
                            currentStepDiv.querySelector('h3').innerHTML = `✓ ${data.step}`;
                        }
                    } else if (data.status === 'error') {
                        if (currentStepDiv && data.step === currentStep) {
                            currentStepDiv.className = 'log-entry error';
                            currentStepDiv.querySelector('h3').innerHTML = `✗ ${data.step}`;
                        }
                    }
                } else if (data.type === 'output') {
                    if (currentOutputPre && data.step === currentStep) {
                        currentOutputPre.textContent += data.line + '\n';
                        content.scrollTop = content.scrollHeight;
                    }
                } else if (data.type === 'complete') {
                    eventSource.close();

                    if (data.success) {
                        showAlert(data.message, 'success');
                        const completeDiv = document.createElement('div');
                        completeDiv.className = 'log-entry success';
                        completeDiv.innerHTML = `<h3>✓ ${actionName}完成</h3><p>${data.message}</p>`;
                        content.appendChild(completeDiv);
                    } else {
                        showAlert(data.message, 'error');
                        const completeDiv = document.createElement('div');
                        completeDiv.className = 'log-entry error';
                        completeDiv.innerHTML = `<h3>✗ ${actionName}失败</h3><p>${data.message}</p>`;
                        content.appendChild(completeDiv);
                    }

                    btn.disabled = false;
                    document.querySelector(`#${buttonId}-${projectId}`).textContent = originalText;
                    content.scrollTop = content.scrollHeight;
                }
            };

            eventSource.onerror = function(error) {
                console.error('EventSource error:', error);
                eventSource.close();
                showAlert(`${actionName}过程中发生错误`, 'error');

                const errorDiv = document.createElement('div');
                errorDiv.className = 'log-entry error';
                errorDiv.innerHTML = `<h3>✗ 连接错误</h3><p>无法连接到服务器</p>`;
                content.appendChild(errorDiv);

                btn.disabled = false;
                document.querySelector(`#${buttonId}-${projectId}`).textContent = originalText;
            };
        }

        // Pull & Build
        function pullBuildProject(projectId) {
            executeStreamAction(projectId, 'pull-build', 'pull-build-text', 'Pull & Build');
        }

        // Down & Up (重启)
        function restartProject(projectId) {
            executeStreamAction(projectId, 'restart', 'restart-text', 'Down & Up');
        }

        // Clean
        function cleanProject(projectId) {
            if (!confirm('确定要执行 docker system prune 吗？这将清理所有未使用的 Docker 资源（镜像、容器、网络等）')) {
                return;
            }
            executeStreamAction(projectId, 'clean', 'clean-text', 'Clean');
        }

        // 切换高级面板显示
        function toggleAdvanced(projectId) {
            const panel = document.getElementById(`advanced-${projectId}`);
            panel.classList.toggle('show');

            // 如果打开了面板，聚焦到输入框
            if (panel.classList.contains('show')) {
                document.getElementById(`custom-command-${projectId}`).focus();
            }
        }

        // 执行自定义命令
        async function executeCustomCommand(projectId) {
            const commandInput = document.getElementById(`custom-command-${projectId}`);
            const command = commandInput.value.trim();

            if (!command) {
                showAlert('请输入命令', 'error');
                return;
            }

            const btn = document.querySelector(`#execute-text-${projectId}`).parentElement;
            const originalText = document.querySelector(`#execute-text-${projectId}`).textContent;

            btn.disabled = true;
            document.querySelector(`#execute-text-${projectId}`).innerHTML = '<span class="loading"></span> 执行中...';

            // 打开日志模态窗口
            const modal = document.getElementById('logModal');
            const content = document.getElementById('logContent');
            content.innerHTML = `<div class="log-entry"><h3>准备执行自定义命令...</h3><pre>${command}</pre></div>`;
            modal.style.display = 'block';

            try {
                // 发起POST请求，包含命令
                const response = await fetch(`/api/custom-command/${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: command })
                });

                // 检查是否返回错误
                if (!response.ok) {
                    const errorData = await response.json();
                    showAlert(errorData.message || '命令执行失败', 'error');
                    btn.disabled = false;
                    document.querySelector(`#execute-text-${projectId}`).textContent = originalText;
                    return;
                }

                // 使用 EventSource 接收实时流式数据
                const eventSource = new EventSource(`/api/custom-command/${projectId}?command=${encodeURIComponent(command)}`);
                let currentStep = null;
                let currentStepDiv = null;
                let currentOutputPre = null;

                // 由于SSE不支持POST，我们需要修改策略
                // 实际上应该先POST再用一个session ID来获取流，但为了简化，我们改用不同的方法

                // 关闭EventSource，因为我们会用fetch
                eventSource.close();

                // 重新使用fetch但读取流
                const streamResponse = await fetch(`/api/custom-command/${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: command })
                });

                const reader = streamResponse.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.substring(6));

                            if (data.type === 'start') {
                                content.innerHTML = `<div class="log-entry"><h3>执行命令: ${data.command}</h3></div>`;
                            } else if (data.type === 'step') {
                                if (data.status === 'running') {
                                    currentStep = data.step;
                                    currentStepDiv = document.createElement('div');
                                    currentStepDiv.className = 'log-entry';
                                    currentStepDiv.innerHTML = `
                                        <h3><span class="loading"></span> ${data.step}...</h3>
                                        <pre class="log-output"></pre>
                                    `;
                                    content.appendChild(currentStepDiv);
                                    currentOutputPre = currentStepDiv.querySelector('.log-output');
                                    content.scrollTop = content.scrollHeight;
                                } else if (data.status === 'success') {
                                    if (currentStepDiv) {
                                        currentStepDiv.className = 'log-entry success';
                                        currentStepDiv.querySelector('h3').innerHTML = `✓ ${data.step}`;
                                    }
                                } else if (data.status === 'error') {
                                    if (currentStepDiv) {
                                        currentStepDiv.className = 'log-entry error';
                                        currentStepDiv.querySelector('h3').innerHTML = `✗ ${data.step}`;
                                    }
                                }
                            } else if (data.type === 'output') {
                                if (currentOutputPre) {
                                    currentOutputPre.textContent += data.line + '\n';
                                    content.scrollTop = content.scrollHeight;
                                }
                            } else if (data.type === 'complete') {
                                if (data.success) {
                                    showAlert(data.message, 'success');
                                    const completeDiv = document.createElement('div');
                                    completeDiv.className = 'log-entry success';
                                    completeDiv.innerHTML = `<h3>✓ 命令执行完成</h3><p>${data.message}</p>`;
                                    content.appendChild(completeDiv);

                                    // 清空输入框
                                    commandInput.value = '';
                                } else {
                                    showAlert(data.message, 'error');
                                    const completeDiv = document.createElement('div');
                                    completeDiv.className = 'log-entry error';
                                    completeDiv.innerHTML = `<h3>✗ 命令执行失败</h3><p>${data.message}</p>`;
                                    content.appendChild(completeDiv);
                                }

                                btn.disabled = false;
                                document.querySelector(`#execute-text-${projectId}`).textContent = originalText;
                                content.scrollTop = content.scrollHeight;
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('Custom command error:', error);
                showAlert('命令执行出错: ' + error.message, 'error');
                btn.disabled = false;
                document.querySelector(`#execute-text-${projectId}`).textContent = originalText;
            }
        }

        // 切换状态显示
        async function toggleStatus(projectId) {
            const statusDiv = document.getElementById(`status-${projectId}`);

            if (statusDiv.classList.contains('show')) {
                statusDiv.classList.remove('show');
                return;
            }

            const contentDiv = document.getElementById(`status-content-${projectId}`);
            contentDiv.innerHTML = '加载中...';
            statusDiv.classList.add('show');

            try {
                const response = await fetch(`/api/status/${projectId}`);
                const result = await response.json();

                if (result.success) {
                    contentDiv.innerHTML = `
                        <p><strong>分支:</strong> ${result.git_branch}</p>
                        <p><strong>最新提交:</strong></p>
                        <pre>${result.git_log}</pre>
                        <p><strong>Git 状态:</strong></p>
                        <pre>${result.git_status || '工作目录干净'}</pre>
                        <p><strong>Docker 容器状态:</strong></p>
                        <pre>${result.docker_status}</pre>
                    `;
                } else {
                    contentDiv.innerHTML = '<p style="color: red;">获取状态失败</p>';
                }
            } catch (error) {
                contentDiv.innerHTML = '<p style="color: red;">获取状态失败: ' + error.message + '</p>';
            }
        }

        // 显示日志
        function showLogs(logs) {
            const modal = document.getElementById('logModal');
            const content = document.getElementById('logContent');

            content.innerHTML = logs.map(log => {
                if (log.output) {
                    return `
                        <div class="log-entry ${log.success ? 'success' : 'error'}">
                            <h3>${log.step} ${log.success ? '✓' : '✗'}</h3>
                            <pre>${log.output}</pre>
                        </div>
                    `;
                }
                return '';
            }).join('');

            modal.style.display = 'block';
        }

        // 显示提示
        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // 显示系统信息
        async function showSystemInfo() {
            const modal = document.getElementById('systemModal');
            const content = document.getElementById('systemContent');

            content.innerHTML = '加载中...';
            modal.style.display = 'block';

            try {
                const [infoResponse, versionResponse] = await Promise.all([
                    fetch('/api/system/info'),
                    fetch('/api/system/version')
                ]);

                const result = await infoResponse.json();
                const versionResult = await versionResponse.json();

                if (result.success) {
                    let versionHtml = '';
                    if (versionResult.success) {
                        const updateBadge = versionResult.has_update
                            ? `<span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 10px;">有 ${versionResult.behind_count} 个更新</span>`
                            : `<span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 10px;">已是最新</span>`;

                        versionHtml = `
                            <div style="margin-bottom: 20px; background: #e3f2fd; padding: 15px; border-radius: 6px;">
                                <h3>版本信息 ${updateBadge}</h3>
                                <p style="margin: 10px 0;"><strong>分支:</strong> ${versionResult.branch}</p>
                                <p style="margin: 10px 0;"><strong>版本:</strong> ${versionResult.commit}</p>
                                ${versionResult.has_update ? `
                                    <button class="btn btn-deploy" onclick="updateSystem()" style="margin-top: 10px;">立即更新</button>
                                ` : ''}
                            </div>
                        `;
                    }

                    content.innerHTML = versionHtml + `
                        <div style="margin-bottom: 20px;">
                            <h3>磁盘使用情况</h3>
                            <pre style="background: #f5f5f5; padding: 15px; border-radius: 6px; overflow-x: auto;">${result.disk}</pre>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3>内存使用情况</h3>
                            <pre style="background: #f5f5f5; padding: 15px; border-radius: 6px; overflow-x: auto;">${result.memory}</pre>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3>CPU 使用情况</h3>
                            <pre style="background: #f5f5f5; padding: 15px; border-radius: 6px; overflow-x: auto;">${result.cpu}</pre>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3>系统负载</h3>
                            <pre style="background: #f5f5f5; padding: 15px; border-radius: 6px; overflow-x: auto;">${result.uptime}</pre>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3>Docker 磁盘使用</h3>
                            <pre style="background: #f5f5f5; padding: 15px; border-radius: 6px; overflow-x: auto;">${result.docker_disk}</pre>
                        </div>
                    `;
                } else {
                    content.innerHTML = '<p style="color: red;">获取系统信息失败</p>';
                }
            } catch (error) {
                content.innerHTML = '<p style="color: red;">获取系统信息失败: ' + error.message + '</p>';
            }
        }

        // 更新系统
        async function updateSystem() {
            if (!confirm('确定要更新系统吗？更新过程中服务将短暂中断。')) {
                return;
            }

            try {
                const response = await fetch('/api/system/update', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    showAlert(result.message, 'success');
                    closeModal('systemModal');

                    // 10秒后自动刷新页面
                    setTimeout(() => {
                        window.location.reload();
                    }, 10000);
                } else {
                    showAlert('更新失败: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('更新失败: ' + error.message, 'error');
            }
        }

        // 显示设置
        async function showSettings() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = 'block';

            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();

                document.getElementById('dingtalk-enabled').checked = settings.dingtalk?.enabled || false;
                document.getElementById('dingtalk-webhook').value = settings.dingtalk?.webhook_url || '';
                document.getElementById('dingtalk-secret').value = settings.dingtalk?.secret || '';

                toggleDingtalkSettings();
            } catch (error) {
                showAlert('加载设置失败: ' + error.message, 'error');
            }
        }

        // 切换钉钉设置显示
        function toggleDingtalkSettings() {
            const enabled = document.getElementById('dingtalk-enabled').checked;
            const settingsDiv = document.getElementById('dingtalk-settings');
            settingsDiv.style.display = enabled ? 'block' : 'none';
        }

        // 保存设置
        async function saveSettings() {
            const settings = {
                dingtalk: {
                    enabled: document.getElementById('dingtalk-enabled').checked,
                    webhook_url: document.getElementById('dingtalk-webhook').value,
                    secret: document.getElementById('dingtalk-secret').value
                }
            };

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                if (result.success) {
                    showAlert('设置保存成功', 'success');
                } else {
                    showAlert('设置保存失败: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('设置保存失败: ' + error.message, 'error');
            }
        }

        // 测试钉钉通知
        async function testDingtalk() {
            try {
                const response = await fetch('/api/test-dingtalk', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    showAlert('测试消息已发送，请检查钉钉群', 'success');
                } else {
                    showAlert('发送失败: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('发送失败: ' + error.message, 'error');
            }
        }

        // 显示项目管理
        function showProjectManagement() {
            const modal = document.getElementById('projectManagementModal');
            modal.style.display = 'block';
            loadProjectsList();
        }

        // 加载项目列表（用于项目管理）
        async function loadProjectsList() {
            try {
                const response = await fetch('/api/projects');
                const projectsData = await response.json();

                const listDiv = document.getElementById('projectsList');
                if (projectsData.length === 0) {
                    listDiv.innerHTML = '<p style="text-align: center; color: #999;">暂无项目</p>';
                    return;
                }

                listDiv.innerHTML = projectsData.map((project, index) => {
                    const sshInfo = project.ssh && project.ssh.enabled
                        ? `<span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; margin-left: 10px;">SSH: ${project.ssh.host}</span>`
                        : '<span style="background: #4caf50; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; margin-left: 10px;">本地</span>';

                    return `
                        <div style="background: white; padding: 15px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ddd;">
                            <h3 style="margin-bottom: 10px;">${project.name}${sshInfo}</h3>
                            <p style="color: #666; margin-bottom: 5px;">${project.description || '暂无描述'}</p>
                            <p style="color: #999; font-family: monospace; margin-bottom: 10px;">${project.path}</p>
                            <p style="margin-bottom: 10px;">
                                <span style="color: ${project.auto_restart ? '#4caf50' : '#999'};">
                                    ${project.auto_restart ? '✓ 自动重启' : '✗ 不自动重启'}
                                </span>
                            </p>
                            <button class="btn btn-status" onclick="editProject(${index})" style="margin-right: 10px;">编辑</button>
                            <button class="btn btn-status" onclick="deleteProject(${index})" style="background: #f44336; color: white;">删除</button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                showAlert('加载项目列表失败: ' + error.message, 'error');
            }
        }

        // 切换SSH字段显示/隐藏
        function toggleSSHFields() {
            const enabled = document.getElementById('ssh-enabled').checked;
            document.getElementById('ssh-fields').style.display = enabled ? 'block' : 'none';
        }

        // 切换SSH认证方式字段
        function toggleSSHAuthFields() {
            const authType = document.getElementById('ssh-auth-type').value;
            document.getElementById('ssh-key-field').style.display = authType === 'key' ? 'block' : 'none';
            document.getElementById('ssh-password-field').style.display = authType === 'password' ? 'block' : 'none';
        }

        // 显示添加项目表单
        function showAddProjectForm() {
            document.getElementById('addProjectForm').style.display = 'block';
            document.getElementById('edit-project-id').value = '';
            document.getElementById('project-name').value = '';
            document.getElementById('project-description').value = '';
            document.getElementById('project-path').value = '';
            document.getElementById('project-auto-restart').checked = true;

            // 重置SSH字段
            document.getElementById('ssh-enabled').checked = false;
            document.getElementById('ssh-host').value = '';
            document.getElementById('ssh-port').value = '22';
            document.getElementById('ssh-user').value = 'root';
            document.getElementById('ssh-auth-type').value = 'key';
            document.getElementById('ssh-key-file').value = '';
            document.getElementById('ssh-password').value = '';
            toggleSSHFields();
            toggleSSHAuthFields();
        }

        // 编辑项目
        function editProject(projectId) {
            const project = projects[projectId];
            document.getElementById('addProjectForm').style.display = 'block';
            document.getElementById('edit-project-id').value = projectId;
            document.getElementById('project-name').value = project.name;
            document.getElementById('project-description').value = project.description || '';
            document.getElementById('project-path').value = project.path;
            document.getElementById('project-auto-restart').checked = project.auto_restart;

            // 加载SSH配置
            const ssh = project.ssh || {};
            document.getElementById('ssh-enabled').checked = ssh.enabled || false;
            document.getElementById('ssh-host').value = ssh.host || '';
            document.getElementById('ssh-port').value = ssh.port || 22;
            document.getElementById('ssh-user').value = ssh.user || 'root';

            if (ssh.password) {
                document.getElementById('ssh-auth-type').value = 'password';
                document.getElementById('ssh-password').value = ssh.password;
            } else {
                document.getElementById('ssh-auth-type').value = 'key';
                document.getElementById('ssh-key-file').value = ssh.key_file || '';
            }

            toggleSSHFields();
            toggleSSHAuthFields();
        }

        // 保存项目
        async function saveProject() {
            const projectId = document.getElementById('edit-project-id').value;
            const projectData = {
                name: document.getElementById('project-name').value,
                description: document.getElementById('project-description').value,
                path: document.getElementById('project-path').value,
                auto_restart: document.getElementById('project-auto-restart').checked
            };

            // 添加SSH配置
            if (document.getElementById('ssh-enabled').checked) {
                const authType = document.getElementById('ssh-auth-type').value;
                const sshHost = document.getElementById('ssh-host').value.trim();

                if (!sshHost) {
                    showAlert('启用SSH时必须填写SSH主机', 'error');
                    return;
                }

                projectData.ssh = {
                    enabled: true,
                    host: sshHost,
                    port: parseInt(document.getElementById('ssh-port').value) || 22,
                    user: document.getElementById('ssh-user').value || 'root'
                };

                if (authType === 'key') {
                    const keyFile = document.getElementById('ssh-key-file').value.trim();
                    if (keyFile) {
                        projectData.ssh.key_file = keyFile;
                    }
                } else {
                    const password = document.getElementById('ssh-password').value;
                    if (password) {
                        projectData.ssh.password = password;
                    } else {
                        showAlert('使用密码认证时必须填写密码', 'error');
                        return;
                    }
                }
            }

            if (!projectData.name || !projectData.path) {
                showAlert('项目名称和路径不能为空', 'error');
                return;
            }

            try {
                let response;
                if (projectId === '') {
                    // 添加新项目
                    response = await fetch('/api/projects', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(projectData)
                    });
                } else {
                    // 更新项目
                    response = await fetch(`/api/projects/${projectId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(projectData)
                    });
                }

                const result = await response.json();
                if (result.success) {
                    showAlert(result.message, 'success');
                    cancelProjectForm();
                    loadProjectsList();
                    loadProjects(); // 重新加载首页项目列表
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('保存项目失败: ' + error.message, 'error');
            }
        }

        // 删除项目
        async function deleteProject(projectId) {
            if (!confirm('确定要删除此项目吗？')) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showAlert(result.message, 'success');
                    loadProjectsList();
                    loadProjects(); // 重新加载首页项目列表
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('删除项目失败: ' + error.message, 'error');
            }
        }

        // 取消项目表单
        function cancelProjectForm() {
            document.getElementById('addProjectForm').style.display = 'none';
        }

        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // 页面加载时获取项目列表
        loadProjects();
    </script>
</body>
</html>
